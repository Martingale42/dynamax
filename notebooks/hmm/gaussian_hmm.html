
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Gaussian HMM: Cross-validation and Model Selection</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Autoregressive (AR) HMM Demo" href="autoregressive_hmm.html" />
    <link rel="prev" title="Casino HMM: Learning (parameter estimation)" href="casino_hmm_learning.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.gif" class="logo" alt="logo">
  
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  HMMs
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="casino_hmm_inference.html">
   Casino HMM: Inference (state estimation)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="casino_hmm_learning.html">
   Casino HMM: Learning (parameter estimation)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Gaussian HMM: Cross-validation and Model Selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="autoregressive_hmm.html">
   Autoregressive (AR) HMM Demo
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Linear Gaussian SSMs
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/kf_tracking.html">
   Tracking an object using the Kalman filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/kf_linreg.html">
   Online linear regression using Kalman filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_parallel_inference.html">
   Parallel filtering and smoothing in an LG-SSM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_learning.html">
   MAP parameter estimation for an LG-SSM using EM and SGD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_hmc.html">
   Bayesian parameter estimation for an LG-SSM using HMC
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Nonlinear Gaussian SSMs
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_spiral.html">
   Tracking a spiraling object using the extended / unscented Kalman filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_pendulum.html">
   Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_mlp.html">
   Online learning for an MLP using extended Kalman filtering
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Generalized Gaussian SSMs
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../generalized_gaussian_ssm/cmgf_logistic_regression_demo.html">
   Online Logistic Regression using conditional moments Gaussian filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../generalized_gaussian_ssm/cmgf_mlp_classification_demo.html">
   Online learning of an MLP Classifier using conditional moments Gaussian filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../generalized_gaussian_ssm/cmgf_poisson_demo.html">
   Fitting an LDS with Poisson Likelihood using conditional moments Gaussian filter
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html">
   State Space Model (Base class)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html#hidden-markov-model">
   Hidden Markov Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html#linear-gaussian-ssm">
   Linear Gaussian SSM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html#nonlinear-gaussian-gssm">
   Nonlinear Gaussian GSSM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html#generalized-gaussian-gssm">
   Generalized Gaussian GSSM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html#utilities">
   Utilities
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/probml/dynamax"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/probml/dynamax/main?urlpath=tree/docs/notebooks/hmm/gaussian_hmm.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/probml/dynamax/blob/main/docs/notebooks/hmm/gaussian_hmm.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#helper-functions-for-plotting">
   Helper functions for plotting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generate-sample-data">
   Generate sample data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-a-helper-function-to-perform-leave-one-out-cross-validation">
   Write a helper function to perform leave-one-out cross-validation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-individual-and-average-validation-log-likelihods-as-a-function-of-number-of-states">
     Plot the individual and average validation log likelihods as a function of number of states
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states">
     Now fit a model to all the training data using the chosen number of states
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-the-fitted-model">
   Visualize the fitted model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-gaussian-hmms-with-different-constraints-on-the-covariance">
   Comparing Gaussian HMMs with different constraints on the covariance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="gaussian-hmm-cross-validation-and-model-selection">
<h1>Gaussian HMM: Cross-validation and Model Selection<a class="headerlink" href="#gaussian-hmm-cross-validation-and-model-selection" title="Permalink to this heading">¶</a></h1>
<p>A Gaussian HMM has emissions of the form,</p>
<div class="amsmath math notranslate nohighlight" id="equation-7987dbde-445e-4950-907c-50d1e2a6a686">
<span class="eqno">(1)<a class="headerlink" href="#equation-7987dbde-445e-4950-907c-50d1e2a6a686" title="Permalink to this equation">¶</a></span>\[\begin{align}
p(y_t \mid z_t, \theta) &amp;= \mathcal{N}(y_t \mid \mu_{z_t}, \Sigma_{z_t})
\end{align}\]</div>
<p>where the emission parameters <span class="math notranslate nohighlight">\(\theta = \{(\mu_k, \Sigma_k)\}_{k=1}^K\)</span> include the means and covariances for each of the <span class="math notranslate nohighlight">\(K\)</span> discrete states.</p>
<p>Dynamax implements a variety of Gaussian HMMs with different constraints on the parameters (e.g. diagonal, spherical, and tied covariances).
It also includes prior distributions on the parameters. For example, it uses a conjugate <a class="reference external" href="https://en.wikipedia.org/wiki/Normal-inverse-Wishart_distribution">normal-inverse Wishart (NIW)</a> prior for the standard case.</p>
<p>This notebook shows how to:</p>
<ol class="arabic simple">
<li><p>Fit such models using expectation-maximization (EM)</p></li>
<li><p>Use cross-validation to choose the number of discrete states</p></li>
<li><p>Use the log probability of held-out data to choose among different models</p></li>
</ol>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">¶</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dynamax</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;installing dynamax&#39;</span><span class="p">)</span>
    <span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">dynamax</span><span class="p">[</span><span class="n">notebooks</span><span class="p">]</span>
    <span class="kn">import</span> <span class="nn">dynamax</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.random</span> <span class="k">as</span> <span class="nn">jr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vmap</span>

<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">GaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">DiagonalGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">SphericalGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">SharedCovarianceGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.utils.plotting</span> <span class="kn">import</span> <span class="n">CMAP</span><span class="p">,</span> <span class="n">COLORS</span><span class="p">,</span> <span class="n">white_to_color_cmap</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:jax._src.lib.xla_bridge:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions-for-plotting">
<h2>Helper functions for plotting<a class="headerlink" href="#helper-functions-for-plotting" title="Permalink to this heading">¶</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper functions for plotting</span>
<span class="k">def</span> <span class="nf">plot_gaussian_hmm</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Emission Distributions&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">XX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">num_states</span><span class="p">):</span>
        <span class="n">lls</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">emission_distribution</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XX</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">white_to_color_cmap</span><span class="p">(</span><span class="n">COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[</span><span class="n">states</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">emissions</span><span class="p">[</span><span class="n">states</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">emissions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$y_1$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$y_2$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">num_timesteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span>
    <span class="n">emission_dim</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">emission_dim</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">emissions</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">states</span><span class="p">]</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Plot the data superimposed on the generating state sequence</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">):</span>    
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span>
                      <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">COLORS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="s2">&quot;-k&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">means</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="s2">&quot;:k&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$y_{{t,</span><span class="si">{}</span><span class="s2"> }}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Simulated data from an HMM&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="generate-sample-data">
<h2>Generate sample data<a class="headerlink" href="#generate-sample-data" title="Permalink to this heading">¶</a></h2>
<p>As in the preceding notebooks, we start by sampling data from the model. Here, we add a slight wrinkle: we will sample training and test data, where the latter is only used for model selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_train_batches</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_test_batches</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_timesteps</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Make an HMM and sample data and true underlying states</span>
<span class="n">true_num_states</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">emission_dim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">hmm</span> <span class="o">=</span> <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">)</span>

<span class="c1"># Specify parameters of the HMM</span>
<span class="n">initial_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">)</span> <span class="o">/</span> <span class="n">true_num_states</span>
<span class="n">transition_matrix</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">emission_means</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="p">])</span>
<span class="n">emission_covs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">),</span> <span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
<span class="n">true_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">initial_probs</span><span class="o">=</span><span class="n">initial_probs</span><span class="p">,</span>
                                <span class="n">transition_matrix</span><span class="o">=</span><span class="n">transition_matrix</span><span class="p">,</span>
                                <span class="n">emission_means</span><span class="o">=</span><span class="n">emission_means</span><span class="p">,</span>
                                <span class="n">emission_covariances</span><span class="o">=</span><span class="n">emission_covs</span><span class="p">)</span>

<span class="c1"># Sample train, validation, and test data</span>
<span class="n">train_key</span><span class="p">,</span> <span class="n">val_key</span><span class="p">,</span> <span class="n">test_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="o">=</span><span class="n">num_timesteps</span><span class="p">))</span>
<span class="n">train_true_states</span><span class="p">,</span> <span class="n">train_emissions</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train_key</span><span class="p">,</span> <span class="n">num_train_batches</span><span class="p">))</span>
<span class="n">test_true_states</span><span class="p">,</span>  <span class="n">test_emissions</span>  <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span> <span class="n">num_test_batches</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot emissions and true_states in the emissions plane</span>
<span class="n">plot_gaussian_hmm</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_true_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;True HMM emission distribution&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1bc3ff9ae10020f55f1c362a13ec88c0e4c3718523a27c0a9a3c4bd4d14fb9c3.png" src="../../_images/1bc3ff9ae10020f55f1c362a13ec88c0e4c3718523a27c0a9a3c4bd4d14fb9c3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot emissions vs. time with background colored by true state</span>
<span class="n">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_true_states</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fa4ea32b50a9d574afdd2d9ac0e0fc3d69d07589b0e0520cd05c33c195dde6f8.png" src="../../_images/fa4ea32b50a9d574afdd2d9ac0e0fc3d69d07589b0e0520cd05c33c195dde6f8.png" />
</div>
</div>
</section>
<section id="write-a-helper-function-to-perform-leave-one-out-cross-validation">
<h2>Write a helper function to perform leave-one-out cross-validation<a class="headerlink" href="#write-a-helper-function-to-perform-leave-one-out-cross-validation" title="Permalink to this heading">¶</a></h2>
<p>This function fits the data into <em>folds</em> where each fold consists of all
but one of the training sequences. It fits the model to each fold in
parallel, and then computs the log likelihood of the held-out sequence for
each fold. The average held-out log likelihood is what we will use for
determining the number of discrete states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cross_validate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Initialize the parameters using K-Means on the full training set</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
    
    <span class="c1"># Split the training data into folds.</span>
    <span class="c1"># Note: this is memory inefficient but it highlights the use of vmap.</span>
    <span class="n">folds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">train_emissions</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">train_emissions</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_train_batches</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_fit_fold</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
        <span class="n">fit_params</span><span class="p">,</span> <span class="n">train_lps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                                             <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">(</span><span class="n">fit_params</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

    <span class="n">val_lls</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">_fit_fold</span><span class="p">)(</span><span class="n">folds</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val_lls</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">val_lls</span>
</pre></div>
</div>
</div>
</div>
<p>Now run the cross-validation function on a sequence of models with number of states ranging from 2 to 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a range of Gaussian HMMs</span>
<span class="n">all_num_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">test_hmms</span> <span class="o">=</span> <span class="p">[</span><span class="n">GaussianHMM</span><span class="p">(</span><span class="n">num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span> 
          <span class="k">for</span> <span class="n">num_states</span> <span class="ow">in</span> <span class="n">all_num_states</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">test_hmm</span> <span class="ow">in</span> <span class="n">test_hmms</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fitting model with </span><span class="si">{</span><span class="n">test_hmm</span><span class="o">.</span><span class="n">num_states</span><span class="si">}</span><span class="s2"> states&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cross_validate_model</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
    
<span class="n">avg_val_lls</span><span class="p">,</span> <span class="n">all_val_lls</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 2 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 3 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 4 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 5 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 6 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 7 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 8 states
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 9 states
</pre></div>
</div>
</div>
</div>
<section id="plot-the-individual-and-average-validation-log-likelihods-as-a-function-of-number-of-states">
<h3>Plot the individual and average validation log likelihods as a function of number of states<a class="headerlink" href="#plot-the-individual-and-average-validation-log-likelihods-as-a-function-of-number-of-states" title="Permalink to this heading">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_num_states</span><span class="p">,</span> <span class="n">avg_val_lls</span><span class="p">,</span> <span class="s1">&#39;-ko&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">per_fold_val_lls</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_num_states</span><span class="p">,</span> <span class="n">all_val_lls</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">per_fold_val_lls</span><span class="p">),</span> <span class="n">per_fold_val_lls</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;num states ($K$)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;avg. validation log prob.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;avg. validation log prob.&#39;)
</pre></div>
</div>
<img alt="../../_images/27e4a7f5cd9795c8352b5fe047b3ae8f02a8357220e7b5755c6bed255c600b3c.png" src="../../_images/27e4a7f5cd9795c8352b5fe047b3ae8f02a8357220e7b5755c6bed255c600b3c.png" />
</div>
</div>
<p>There’s no right answer for how to choose the number of states, but reasonable heuristics include:</p>
<ul class="simple">
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> that has the highest average validation log prob</p></li>
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> where the average validation log prob stops increasing by a minimum amount</p></li>
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> with a hypothesis test for increasing mean</p></li>
</ul>
<p>Here, we’ll just choose the number of states with the highest average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_num_states</span> <span class="o">=</span> <span class="n">all_num_states</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">avg_val_lls</span><span class="p">))]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best number of states:&quot;</span><span class="p">,</span> <span class="n">best_num_states</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>best number of states: 5
</pre></div>
</div>
</div>
</div>
</section>
<section id="now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states">
<h3>Now fit a model to all the training data using the chosen number of states<a class="headerlink" href="#now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states" title="Permalink to this heading">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the parameters using K-Means on the full training set</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_hmm</span> <span class="o">=</span> <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">best_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
<span class="n">params</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 00:01&lt;00:00]
    </div>
    </div></div>
</div>
<p>Plot the log probabilities over the course of training, along with those of the model with the parameters that generated the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate the log probability of the training data under the true parameters</span>
<span class="n">true_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">params</span><span class="p">))(</span><span class="n">train_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">true_lp</span> <span class="o">+=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">log_prior</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># Plot log probs vs num_iterations</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lps</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">),</span> <span class="n">lps</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">true_lp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;num epochs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;log prob&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f1efb0baeb0&gt;
</pre></div>
</div>
<img alt="../../_images/0231aa6a98b617f5584e9d9628e1d272a4914a96bce5be1f8d36b1271f2b4c6d.png" src="../../_images/0231aa6a98b617f5584e9d9628e1d272a4914a96bce5be1f8d36b1271f2b4c6d.png" />
</div>
</div>
</section>
</section>
<section id="visualize-the-fitted-model">
<h2>Visualize the fitted model<a class="headerlink" href="#visualize-the-fitted-model" title="Permalink to this heading">¶</a></h2>
<p>We’ll make the same plots as above, but now using the fitted parameters and the chosen number of states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">most_likely_states</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">most_likely_states</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_gaussian_hmm</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">most_likely_states</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fitted Model with </span><span class="si">{</span><span class="n">best_num_states</span><span class="si">}</span><span class="s2"> states&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6b2a8ea193c2ab2f86c3b1e52a74155b5dc89a2598e380636552d72169f9bc8c.png" src="../../_images/6b2a8ea193c2ab2f86c3b1e52a74155b5dc89a2598e380636552d72169f9bc8c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">most_likely_states</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d69145039e6e213a4639cae81bdbf8e3f03389ef85b6a37172140f29469c0f1f.png" src="../../_images/d69145039e6e213a4639cae81bdbf8e3f03389ef85b6a37172140f29469c0f1f.png" />
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note that the marginal log probability is invariant to relabeling of the states. Compare these plots to the ones at the top from the true model. You’ll see that the states have been permuted.</p>
</div>
</section>
<section id="comparing-gaussian-hmms-with-different-constraints-on-the-covariance">
<h2>Comparing Gaussian HMMs with different constraints on the covariance<a class="headerlink" href="#comparing-gaussian-hmms-with-different-constraints-on-the-covariance" title="Permalink to this heading">¶</a></h2>
<p>Dynamax implements Gaussian HMMs with different constraints on the covariance matrices:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.DiagonalGaussianHMM"><code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code></a> assumes the covariance matrices are diagonal (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \mathrm{diag}([\sigma_{k,1}^2, \ldots, \sigma_{k,D}^2])\)</span>)</p></li>
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.SphericalGaussianHMM"><code class="docutils literal notranslate"><span class="pre">SphericalGaussianHMM</span></code></a> assumes the covariance matrices are “spherical” (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \sigma_k^2 I\)</span>)</p></li>
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.SharedCovarianceGaussianHMM"><code class="docutils literal notranslate"><span class="pre">SharedCovarianceGaussianHMM</span></code></a> assumes the covariance matrices are the same for all states (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \Sigma\)</span>)</p></li>
</ul>
<p>In this last section, we will compare these models based on the marginal probability they assign to the test data.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Usually, you would use cross-validation to choose the number of discrete states for each type of model, and then evaluate them on test data. For simplicity, we will assume that we know the true number of states.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Initialize the parameters using K-Means on the full training set</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">params</span><span class="p">))(</span><span class="n">test_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">test_lp</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">DiagonalGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">SphericalGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">SharedCovarianceGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Fit the models and collect the test log probabilities</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_lps</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<span class="c1"># Compare to the log probability under the true model</span>
<span class="n">true_test_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">true_params</span><span class="p">))(</span><span class="n">test_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Marginal log probabilities of test data:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_lp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">test_lps</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">:</span><span class="s2"> &gt;30</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">test_lp</span><span class="si">:</span><span class="s2"> .1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;True Model&#39;</span><span class="si">:</span><span class="s2"> &gt;30</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">true_test_lp</span><span class="si">:</span><span class="s2"> .1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Marginal log probabilities of test data:
                   GaussianHMM:  92.7
           DiagonalGaussianHMM:  109.0
          SphericalGaussianHMM:  102.2
   SharedCovarianceGaussianHMM:  103.7
                    True Model:  109.8
</pre></div>
</div>
</div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code> has the highest test log likelihood, and it’s almost as high as the log probability under the true parameters. The standard <code class="docutils literal notranslate"><span class="pre">GaussianHMM</span></code>, which allows for arbitrary covariance matrices is underperforming on test data, likely because it overfits the training data with its extra flexibility.</p>
<p>Here, the true parameters were in fact spherical and shared across all states, so it’s perhaps a bit surprising that the more general diagonal covariance model wins out on test data. Keep in mind, however, that there is some amount of randomness in both the sampled data and the initialization of these models, so the particular ordering might change from one random seed to the next. In actual applications, you should compute means and standard errors by running these analyses with multiple random seeds.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">¶</a></h2>
<p>Dynamax provides a family of Gaussian HMMs for multivariate continuous emissions. This notebook showed how to use cross-validation to choose the number of discrete states, and how to compare model families (e.g. <code class="docutils literal notranslate"><span class="pre">GaussianHMM</span></code> vs <code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code>) on test data.</p>
<p>Now that you have seen HMMs with categorical and Gaussian emissions, you can pattern-match to use the other HMMs. See the <a class="reference external" href="https://probml.github.io/dynamax/api.html#high-level-models">documentation</a> for a complete list.</p>
<p>The next notebook highlights one more generalization of the standard HMM to <em>autoregressive</em> emissions, where the emissions depend on preceding emissions as well as the current discrete state.</p>
</section>
</section>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="casino_hmm_learning.html" title="previous page">Casino HMM: Learning (parameter estimation)</a>
    <a class='right-next' id="next-link" href="autoregressive_hmm.html" title="next page">Autoregressive (AR) HMM Demo</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy<br/>
        
            &copy; Copyright 2022, Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>