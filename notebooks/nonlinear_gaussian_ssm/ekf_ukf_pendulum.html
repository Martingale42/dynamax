
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/nonlinear_gaussian_ssm/ekf_ukf_pendulum';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Online learning for an MLP using extended Kalman filtering" href="ekf_mlp.html" />
    <link rel="prev" title="Tracking a spiraling object using the extended / unscented Kalman filter" href="ekf_ukf_spiral.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.gif" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../_static/logo.gif" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">HMMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../hmm/casino_hmm_inference.html">Casino HMM: Inference (state estimation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hmm/casino_hmm_learning.html">Casino HMM: Learning (parameter estimation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hmm/gaussian_hmm.html">Gaussian HMM: Cross-validation and Model Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hmm/autoregressive_hmm.html">Autoregressive (AR) HMM Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hmm/custom_hmm.html">Creating Custom HMMs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Linear Gaussian SSMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/kf_tracking.html">Tracking an object using the Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/kf_linreg.html">Online linear regression using Kalman filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_parallel_inference.html">Parallel filtering and smoothing in an LG-SSM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_learning.html">MAP parameter estimation for an LG-SSM using EM and SGD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_hmc.html">Bayesian parameter estimation for an LG-SSM using HMC</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Nonlinear Gaussian SSMs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ekf_ukf_spiral.html">Tracking a spiraling object using the extended / unscented Kalman filter</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother</a></li>
<li class="toctree-l1"><a class="reference internal" href="ekf_mlp.html">Online learning for an MLP using extended Kalman filtering</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Generalized Gaussian SSMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_logistic_regression_demo.html">Online Logistic Regression using conditional moments Gaussian filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_mlp_classification_demo.html">Online learning of an MLP Classifier using conditional moments Gaussian filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_poisson_demo.html">State Inference in a Poisson LDS using the Conditional Moments Gaussian Smoother</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../types.html">Terminology for types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">State Space Model (Base class)</a></li>





</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/probml/dynamax/main?urlpath=tree/docs/notebooks/nonlinear_gaussian_ssm/ekf_ukf_pendulum.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/probml/dynamax/blob/main/docs/notebooks/nonlinear_gaussian_ssm/ekf_ukf_pendulum.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/probml/dynamax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sample-data-and-plot-it">Sample data and plot it</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-fucntions-for-evaluating-estimates">Helper fucntions for evaluating estimates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-kalman-filter-smoother">Extended Kalman Filter / Smoother</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unscented-kalman-filter-smoother">Unscented Kalman Filter / Smoother</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameters">Hyperparameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tracking-a-1d-pendulum-using-extended-unscented-kalman-filter-smoother">
<h1>Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother<a class="headerlink" href="#tracking-a-1d-pendulum-using-extended-unscented-kalman-filter-smoother" title="Link to this heading">#</a></h1>
<p>This notebook demonstrates a simple pendulum tracking example.
The example is taken from p45 of
<em>Bayesian Filtering and Smoothing</em> (S. Särkkä, 2013).
This code is based on the  <a class="reference external" href="https://github.com/petergchang/sarkka-jax">sarkka-jax</a> repo.</p>
<p>The physics of the problem is shown below, where <span class="math notranslate nohighlight">\(\alpha\)</span> is the angle relative to vertical,
and <span class="math notranslate nohighlight">\(w(t)\)</span> is a white noise process added to the angular velocity (a random acceleration term).</p>
<p><img alt="Pendulum" src="https://github.com/probml/dynamax/blob/main/docs/figures/pendulum.png?raw=true" /></p>
<p>This gives rise to the following differential equation:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\frac{\mathrm{d}^2 \alpha}{\mathrm{d} t^2}
= -g \sin(\alpha) + w(t)
\end{align*}\]</div>
<p>We can write this as a nonlinear SSM by defining the state to be
<span class="math notranslate nohighlight">\(z_1(t) = \alpha(t)\)</span> and <span class="math notranslate nohighlight">\(z_2(t) = \mathrm{d}\alpha(t)/\mathrm{d}t\)</span>.
Thus</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\frac{\mathrm{d} z}{\mathrm{d}t}
= \begin{pmatrix} z_2 \\ -g \sin(z_1) \end{pmatrix}
+ \begin{pmatrix} 0 \\ 1 \end{pmatrix} w(t)
\end{align*}\]</div>
<p>If we discretize this step size <span class="math notranslate nohighlight">\(\Delta\)</span>,
we get the following formulation:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
  \begin{pmatrix} z_{1,t} \\ z_{2,t} \end{pmatrix}
=
  \begin{pmatrix} z_{1,t-1} + z_{2,t-1} \Delta  \\
    z_{2,t-1} -g \sin(z_{1,t-1}) \Delta 
     \end{pmatrix}
+q_{t} 
\end{align*}\]</div>
<p>where <span class="math notranslate nohighlight">\(q_t \sim N(0,Q)\)</span>, and</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{equation*}
Q = q^c
\begin{pmatrix}
  \frac{\Delta^3}{3} &amp;   \frac{\Delta^2}{2} \\
  \frac{\Delta^2}{2} &amp; \Delta 
  \end{pmatrix} 
\end{equation*}\]</div>
<p>where <span class="math notranslate nohighlight">\(q^c\)</span> is the spectral density
of the continuous-time noise process.</p>
<p>We assume the observation model is</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
y_t &amp;= h(z_t) + r_t \\
h(z_t) &amp;=  \sin(\alpha_t)  = \sin(z_{t,1}) \\
r_t &amp;\sim \mathrm{N}(0,R)
\end{align*}\]</div>
<p>This corresponds to receiving noisy measurements of the horizontal position of the pendulum.</p>
<p>We show how to perform approximate inference of the latent states in this nonlinear dynamical system model using an Extended Kalman Filter (EKF) or an Unscented Kalman Filter (UKF). These algorithms work by approximating the nonlinear model with a linear Gaussian model, with two different types of approximations. For more detail on these algorithms, see Murphy (2023) or Särkkä and Svensson (2023).</p>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Murphy, Kevin P. Probabilistic machine learning: Advanced topics. MIT press, 2023.</p></li>
<li><p>Särkkä, Simo, and Lennart Svensson. Bayesian filtering and smoothing. Vol. 17. Cambridge university press, 2023.</p></li>
</ul>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">dynamax</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;installing dynamax&#39;</span><span class="p">)</span>
    <span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">dynamax</span><span class="p">[</span><span class="n">notebooks</span><span class="p">]</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">dynamax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.random</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jaxtyping</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">NamedTuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dynamax.nonlinear_gaussian_ssm</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParamsNLGSSM</span><span class="p">,</span> <span class="n">UKFHyperParams</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dynamax.nonlinear_gaussian_ssm</span><span class="w"> </span><span class="kn">import</span> <span class="n">extended_kalman_smoother</span> <span class="k">as</span> <span class="n">ekf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dynamax.nonlinear_gaussian_ssm</span><span class="w"> </span><span class="kn">import</span> <span class="n">unscented_kalman_smoother</span> <span class="k">as</span> <span class="n">ukf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For pretty print of ndarrays</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;float_kind&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="sample-data-and-plot-it">
<h2>Sample data and plot it<a class="headerlink" href="#sample-data-and-plot-it" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Some parameters</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.0125</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.8</span>
<span class="n">q_c</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="c1"># Lightweight container for pendulum parameters</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PendulumParams</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot;state_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">dynamics_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span><span class="p">])</span>
    <span class="n">dynamics_covariance</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot;state_dim state_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">q_c</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">q_c</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">q_c</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">q_c</span> <span class="o">*</span> <span class="n">dt</span><span class="p">]])</span>
    <span class="n">emission_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="n">emission_covariance</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot;emission_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pendulum simulation (Särkkä Example 3.7)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">simulate_pendulum</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">PendulumParams</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># Unpack parameters</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">initial_state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">emission_covariance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dynamics_function</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">emission_function</span>
    <span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dynamics_covariance</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">emission_covariance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_step</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">rng1</span><span class="p">,</span> <span class="n">rng2</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">next_state</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">jr</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">rng1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">Q</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span> <span class="o">+</span> <span class="n">jr</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">rng2</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">R</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="p">(</span><span class="n">next_state</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>

    <span class="n">rngs</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">_step</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">rngs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">states</span><span class="p">,</span> <span class="n">observations</span>


<span class="n">states</span><span class="p">,</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">simulate_pendulum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">x_tr</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">x_tr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkgray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Angle&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Measurements&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x_est</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">x_est</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">est_type</span><span class="si">}</span><span class="s2"> Estimate&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time $t$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pendulum angle $x_{1,k}$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">4.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">handlelength</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create time grid for plotting</span>
<span class="n">time_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>

<span class="c1"># Plot the generated data</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c87819708caa30259afb6ee09d7337c31135061f25a0aa5a5149979701dbedf5.png" src="../../_images/c87819708caa30259afb6ee09d7337c31135061f25a0aa5a5149979701dbedf5.png" />
</div>
</div>
<section id="helper-fucntions-for-evaluating-estimates">
<h3>Helper fucntions for evaluating estimates<a class="headerlink" href="#helper-fucntions-for-evaluating-estimates" title="Link to this heading">#</a></h3>
<p>We use the functions below to compute and print the errors associated with various state estimates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute RMSE</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_rmse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_est</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_est</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>


<span class="c1"># Compute RMSE of estimate and print comparison with</span>
<span class="c1"># standard deviation of measurement noise</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_est</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">rmse_est</span> <span class="o">=</span> <span class="n">compute_rmse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_est</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The RMSE of the </span><span class="si">{</span><span class="n">est_type</span><span class="si">}</span><span class="s2"> estimate is: </span><span class="si">{</span><span class="n">rmse_est</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The std of measurement noise is: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="extended-kalman-filter-smoother">
<h2>Extended Kalman Filter / Smoother<a class="headerlink" href="#extended-kalman-filter-smoother" title="Link to this heading">#</a></h2>
<p>The extended Kalman filter (EKF) is an approximate inference algorithm for systems with nonlinear dynamics and/or emissions and Gaussian noise. It works by using a first-order Taylor approximation to the dynamics and/or emissions functions, and the n running a standard Kalman filter on the “linearized” model. The EKF tends to work well when the dynamics and emissions are well-approximated by their first-order Taylor function around the predictive means, and when the Jacobians of these functions are available. Dynamax uses automatic differentiation to compute these Jacobians.</p>
<p>The <em>filter</em> computes estimates of the latent states based on observations up to and including time <span class="math notranslate nohighlight">\(t\)</span>, whereas the <em>smoother</em> estimates states based on all observations through time <span class="math notranslate nohighlight">\(T\)</span>.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
p(z_t \mid y_{1:t}; \theta) &amp; &amp; &amp; \text{(filter)} \\
p(z_t \mid y_{1:T}; \theta) &amp; &amp; &amp; \text{(smoother)}
\end{align*}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pendulum_params</span> <span class="o">=</span> <span class="n">PendulumParams</span><span class="p">()</span>

<span class="c1"># Define parameters for EKF</span>
<span class="n">ekf_params</span> <span class="o">=</span> <span class="n">ParamsNLGSSM</span><span class="p">(</span>
    <span class="n">initial_mean</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">initial_covariance</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">dynamics_function</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">dynamics_function</span><span class="p">,</span>
    <span class="n">dynamics_covariance</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">dynamics_covariance</span><span class="p">,</span>
    <span class="n">emission_function</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">emission_function</span><span class="p">,</span>
    <span class="n">emission_covariance</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">emission_covariance</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ekf_posterior</span> <span class="o">=</span> <span class="n">ekf</span><span class="p">(</span><span class="n">ekf_params</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_ekf</span> <span class="o">=</span> <span class="n">ekf_posterior</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="n">m_ekf</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;EKF&quot;</span><span class="p">)</span>
<span class="n">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_ekf</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;EKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/490b91fdf53d7072012093842c4e89843a91566558559f57eeb44be74354cdd7.png" src="../../_images/490b91fdf53d7072012093842c4e89843a91566558559f57eeb44be74354cdd7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The RMSE of the EKF estimate is: 0.13
The std of measurement noise is: 0.55
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_ekf</span> <span class="o">=</span> <span class="n">ekf_posterior</span><span class="o">.</span><span class="n">smoothed_means</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="n">m_ekf</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;EKS&quot;</span><span class="p">)</span>
<span class="n">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_ekf</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;EKS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/42d597b57dd73efad1589ad4edc3d5b91883b1740b712f2b6aefd00487c07535.png" src="../../_images/42d597b57dd73efad1589ad4edc3d5b91883b1740b712f2b6aefd00487c07535.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The RMSE of the EKS estimate is: 0.06
The std of measurement noise is: 0.55
</pre></div>
</div>
</div>
</div>
</section>
<section id="unscented-kalman-filter-smoother">
<h2>Unscented Kalman Filter / Smoother<a class="headerlink" href="#unscented-kalman-filter-smoother" title="Link to this heading">#</a></h2>
<p>The Unscented Kalman Filter (UKF) works by matching moments of a Gaussian approximation to the filtering and predictive distributions. Briefly, the UKF passes a grid of <em>sigma points</em> through the dynamics and emissions functions, and then uses the weighted mean and covariance of the transformed points to form the Gaussian approximation.</p>
<p>Should you use an EKF or a UKF for your problem? Särkkä (2023; pg. 160) says the following,</p>
<blockquote>
<div><p>the unscented transform is able to capture the higher order moments caused by the non-linear transform better than Taylor series-based approximations. However, as already pointed out in the previous section, although the mean estimate of the UKF is exact for polynomials up to order three, the covariance computation is only exact for polynomials up to first order. In the UKF, the dynamic and model functions are also not required to be formally differentiable nor do their Jacobian matrices need to be computed. The disadvantage over the EKF is that the UKF often re quires slightly more computational operations than the EKF.</p>
</div></blockquote>
<p>Furthermore, as we demonstrate below, the UKF is sensitive to the choice of hyperparameters that determine the sigma points, whereas the EKF is essentially hyperparameter-free.</p>
<p>Finally, as above, you can use either the Unscented Kalman Filter (UKF) or the Unscented Kalman Smoother (UKS) depending on whether you want a causal or acausal state estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pendulum_params</span> <span class="o">=</span> <span class="n">PendulumParams</span><span class="p">()</span>

<span class="n">ukf_params</span> <span class="o">=</span> <span class="n">ParamsNLGSSM</span><span class="p">(</span>
    <span class="n">initial_mean</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">initial_covariance</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">dynamics_function</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">dynamics_function</span><span class="p">,</span>
    <span class="n">dynamics_covariance</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">dynamics_covariance</span><span class="p">,</span>
    <span class="n">emission_function</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">emission_function</span><span class="p">,</span>
    <span class="n">emission_covariance</span><span class="o">=</span><span class="n">pendulum_params</span><span class="o">.</span><span class="n">emission_covariance</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># In this example, the default gives the same results as EKF</span>
<span class="n">ukf_hyperparams</span> <span class="o">=</span> <span class="n">UKFHyperParams</span><span class="p">()</span> 
<span class="n">ukf_posterior</span> <span class="o">=</span> <span class="n">ukf</span><span class="p">(</span><span class="n">ukf_params</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">ukf_hyperparams</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_ukf</span> <span class="o">=</span> <span class="n">ukf_posterior</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="n">m_ukf</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;UKF&quot;</span><span class="p">)</span>
<span class="n">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_ukf</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;UKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bcb9eba271bf8a027685c87552497f3367cce40f9d37d87c91c40f7419d776b3.png" src="../../_images/bcb9eba271bf8a027685c87552497f3367cce40f9d37d87c91c40f7419d776b3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The RMSE of the UKF estimate is: 0.13
The std of measurement noise is: 0.55
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_uks</span> <span class="o">=</span> <span class="n">ukf_posterior</span><span class="o">.</span><span class="n">smoothed_means</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="n">m_uks</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;UKS&quot;</span><span class="p">)</span>
<span class="n">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_uks</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;UKS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8176adda1ce46c6e9045b66539d443f6a472eb85370309ed1e71988acb920497.png" src="../../_images/8176adda1ce46c6e9045b66539d443f6a472eb85370309ed1e71988acb920497.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The RMSE of the UKS estimate is: 0.06
The std of measurement noise is: 0.55
</pre></div>
</div>
</div>
</div>
<section id="hyperparameters">
<h3>Hyperparameters<a class="headerlink" href="#hyperparameters" title="Link to this heading">#</a></h3>
<p>The sigma points in the UKF/UKS are based on hyperparameters <span class="math notranslate nohighlight">\((\alpha, \beta, \kappa)\)</span>, which are detailed in the textbooks above. These hyperparameters can have a significant effect on the state estimates, so you may consider testing a range of settings based on your problem. Again, see the books above for more detail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s see how sensitive UKF is to hyper-params</span>
<span class="n">ukf_hyperparams</span> <span class="o">=</span> <span class="n">UKFHyperParams</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ukf_posterior</span> <span class="o">=</span> <span class="n">ukf</span><span class="p">(</span><span class="n">ukf_params</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">ukf_hyperparams</span><span class="p">)</span>

<span class="n">m_ukf</span> <span class="o">=</span> <span class="n">ukf_posterior</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot_pendulum</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">,</span> <span class="n">x_est</span><span class="o">=</span><span class="n">m_ukf</span><span class="p">,</span> <span class="n">est_type</span><span class="o">=</span><span class="s2">&quot;UKF&quot;</span><span class="p">)</span>
<span class="n">compute_and_print_rmse_comparison</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_ukf</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;UKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/31e9c91520b9b1dd16e4f8869e6edef23e26bfbe790a484316ba266391d05a58.png" src="../../_images/31e9c91520b9b1dd16e4f8869e6edef23e26bfbe790a484316ba266391d05a58.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The RMSE of the UKF estimate is: 0.43
The std of measurement noise is: 0.55
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>This notebook shows how to use the extended and unscented Kalman filter/smoother to infer latent states of a canonical nonlinear dynamical system, a simple pendulum. We saw that the smoothers achieved lower error estimates by considering future observations, but of course that renders them acausal. We also showed how to adjust the UKF hyperparameters, in case the defaults don’t work for your problem.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ekf_ukf_spiral.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tracking a spiraling object using the extended / unscented Kalman filter</p>
      </div>
    </a>
    <a class="right-next"
       href="ekf_mlp.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Online learning for an MLP using extended Kalman filtering</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sample-data-and-plot-it">Sample data and plot it</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-fucntions-for-evaluating-estimates">Helper fucntions for evaluating estimates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-kalman-filter-smoother">Extended Kalman Filter / Smoother</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unscented-kalman-filter-smoother">Unscented Kalman Filter / Smoother</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameters">Hyperparameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022, Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>